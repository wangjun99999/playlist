user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    # =====================================================
    # 缓存区（通用）
    # =====================================================
    proxy_cache_path /var/cache/nginx
        levels=1:2
        keys_zone=my_cache:50m
        max_size=1g
        inactive=30m
        use_temp_path=off;

    # =====================================================
    # token（你可以以后统一控制）
    # =====================================================
    map $arg_token $token_to_check {
        default $cookie_token;
        ~.+ $arg_token;
    }

    map $token_to_check $auth_ok {
        default 0;
        "wangjun0127" 1;
    }

    map $args $args_clean {
        default $args;
        ~^(.*)(^|&)token=[^&]*&?(.*)$  $1$3;
    }

    map $args_clean $redirect_uri {
        ""       $uri;
        default  $uri?$args_clean;
    }

    # =====================================================
    # 【源 1】stream-link 订阅入口
    # =====================================================
    server {
        listen 30001;
        listen [::]:30001;
        server_name _;

        # token（可选）
        if ($auth_ok = 0) {
            return 403;
        }
        if ($arg_token) {
            return 302 $redirect_uri;
        }

        # 必须的请求头（stream-link 强校验）
        proxy_set_header User-Agent "TiviMate/5.1.0";
        proxy_set_header Referer "https://www.stream-link.org/";
        proxy_set_header Host www.stream-link.org;
        proxy_set_header Accept "*/*";
        proxy_set_header Connection "keep-alive";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_ssl_verify off;
        proxy_ssl_server_name on;

        proxy_cache my_cache;
        proxy_cache_valid 200 206 5s;
        expires 5s;

        # playlist.m3u
        location = /playlist.m3u {
            proxy_pass "https://www.stream-link.org/playlist.m3u?token=966e2866-93ff-41d9-9d52-4451dbc1b181&hmac=adbce998d2dbf9397319988f920b5bb3";

            # 重写 ts 域名 → 群晖 30002
            sub_filter 'https://sc2026.stream-link.org' 'http://$host:30002';
            sub_filter_once off;

            gzip off;
            proxy_set_header Accept-Encoding "";
        }

        # 兜底
        location / {
            proxy_pass https://www.stream-link.org;
        }
    }

    # =====================================================
    # 【源 1】stream-link ts / 分流
    # =====================================================
    server {
        listen 30002;
        listen [::]:30002;
        server_name _;

        proxy_set_header User-Agent "TiviMate/5.1.0";
        proxy_set_header Referer "https://www.stream-link.org/";
        proxy_set_header Host sc2026.stream-link.org;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_ssl_verify off;
        proxy_ssl_server_name on;

        proxy_cache my_cache;
        proxy_cache_valid 200 206 10s;
        expires 10s;

        location / {
            proxy_pass https://sc2026.stream-link.org;
        }
    }

    # =====================================================
    # 【源 2】GitHub 4ksp.m3u 订阅
    # =====================================================
    server {
        listen 30003;
        listen [::]:30003;
        server_name _;

        proxy_set_header User-Agent "Mozilla/5.0";
        proxy_set_header Accept "*/*";
        proxy_set_header Connection "keep-alive";

        proxy_ssl_verify off;

        location /4ksp.m3u {
            proxy_pass https://raw.githubusercontent.com/wangjun99999/playlist/refs/heads/main/4ksp.m3u;
        }

        # 直接访问也行
        location / {
            proxy_pass https://raw.githubusercontent.com/wangjun99999/playlist/refs/heads/main/;
        }
    }
}
